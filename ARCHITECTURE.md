# 🏗️ 部署架构说明

## 当前架构（本地开发）

```
┌─────────────────────────────────────────────────────────┐
│                    本地开发环境                          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐         ┌──────────────┐             │
│  │   前端 Vue3   │ ◄────► │  后端 Node.js │             │
│  │ localhost:5173│         │ localhost:3000│             │
│  └──────────────┘         └───────┬───────┘             │
│                                    │                     │
│                                    ▼                     │
│                            ┌──────────────┐             │
│                            │  Git 仓库     │             │
│                            │  ./repos/     │             │
│                            └──────────────┘             │
└─────────────────────────────────────────────────────────┘
```

## 推荐架构（Cloudflare + Railway）

```
┌─────────────────────────────────────────────────────────────────┐
│                          互联网用户                              │
└────────────┬────────────────────────────────────────────────────┘
             │
             │ HTTPS
             │
             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Cloudflare 全球 CDN                           │
│                  (自动 HTTPS + DDoS 防护)                        │
└────────┬────────────────────────────────────────────────────────┘
         │
         ├──────────────────┬──────────────────────────────────────┐
         │                  │                                      │
         │ 静态资源          │ API 请求                              │
         ▼                  ▼                                      │
┌──────────────────┐  ┌──────────────────────────────────────┐   │
│ Cloudflare Pages │  │         Railway/Render               │   │
│                  │  │                                      │   │
│  ┌────────────┐  │  │  ┌────────────────────────────┐    │   │
│  │  Vue3 前端  │  │  │  │     Express 后端           │    │   │
│  │  (静态文件) │  │  │  │                            │    │   │
│  │            │  │  │  │  ┌──────────────────────┐  │    │   │
│  │ - HTML     │  │  │  │  │  API 路由            │  │    │   │
│  │ - CSS      │  │  │  │  │  - /api/auth         │  │    │   │
│  │ - JS       │  │  │  │  │  - /api/repos        │  │    │   │
│  │ - Images   │  │  │  │  │  - /api/users        │  │    │   │
│  └────────────┘  │  │  │  └──────────────────────┘  │    │   │
│                  │  │  │                            │    │   │
│  全球 CDN 加速    │  │  │  ┌──────────────────────┐  │    │   │
│  免费 HTTPS      │  │  │  │  Git HTTP 服务       │  │    │   │
│  无限带宽        │  │  │  │  - /git/:repo        │  │    │   │
└──────────────────┘  │  │  └──────────────────────┘  │    │   │
                      │  │                            │    │   │
                      │  │  ┌──────────────────────┐  │    │   │
                      │  │  │  文件系统            │  │    │   │
                      │  │  │  - Git 仓库存储      │  │    │   │
                      │  │  │  - 用户配置          │  │    │   │
                      │  │  │  - 操作日志          │  │    │   │
                      │  │  └──────────────────────┘  │    │   │
                      │  └────────────────────────────┘    │   │
                      │                                    │   │
                      │  持久化存储                         │   │
                      │  自动扩展                           │   │
                      │  健康检查                           │   │
                      └────────────────────────────────────┘   │
                                                                │
                                                                │
                      ┌─────────────────────────────────────────┘
                      │
                      ▼
              ┌──────────────┐
              │  Git 客户端   │
              │              │
              │ git clone    │
              │ git push     │
              │ git pull     │
              └──────────────┘
```

## 数据流

### 1. 用户访问前端

```
用户浏览器
    │
    │ HTTPS GET https://git-server.pages.dev
    ▼
Cloudflare CDN (边缘节点)
    │
    │ 缓存命中 → 直接返回
    │ 缓存未命中 ↓
    ▼
Cloudflare Pages (源站)
    │
    │ 返回 HTML/CSS/JS
    ▼
用户浏览器 (渲染页面)
```

### 2. 用户登录

```
用户浏览器
    │
    │ POST https://your-backend.railway.app/api/auth/login
    │ { username, password }
    ▼
Railway 后端
    │
    │ 验证用户名密码
    │ 生成 JWT Token
    ▼
返回 Token
    │
    ▼
浏览器存储 Token (localStorage)
```

### 3. 查看仓库列表

```
用户浏览器
    │
    │ GET https://your-backend.railway.app/api/repos
    │ Authorization: Bearer <token>
    ▼
Railway 后端
    │
    │ 验证 Token
    │ 检查权限
    │ 读取仓库配置
    ▼
返回仓库列表 JSON
    │
    ▼
前端渲染列表
```

### 4. Git 推送代码

```
Git 客户端
    │
    │ git push https://your-backend.railway.app/git/repo-name
    │ HTTP Basic Auth (username:password)
    ▼
Railway 后端 (/git/:repo)
    │
    │ 验证用户名密码
    │ 检查推送权限
    │ 执行 git-receive-pack
    ▼
写入 Git 仓库
    │
    │ 记录操作日志
    ▼
返回成功
```

## 技术栈对比

### 前端（Cloudflare Pages）

| 特性 | 说明 |
|------|------|
| 框架 | Vue 3 + Vite |
| UI 库 | Element Plus |
| 路由 | Vue Router |
| HTTP | Axios |
| 部署 | 静态文件托管 |
| CDN | 全球 200+ 节点 |
| HTTPS | 自动配置 |
| 成本 | 免费 |

### 后端（Railway/Render）

| 特性 | 说明 |
|------|------|
| 运行时 | Node.js |
| 框架 | Express |
| 认证 | JWT + HTTP Basic Auth |
| Git | 原生 Git 命令 |
| 存储 | 文件系统 |
| 数据库 | JSON 文件 |
| 日志 | 文件日志 |
| 成本 | $5-7/月 |

## 性能优化

### 前端优化

1. **Cloudflare CDN**
   - 全球边缘节点缓存
   - 自动压缩（Gzip/Brotli）
   - HTTP/2 支持

2. **Vite 构建优化**
   - 代码分割
   - Tree Shaking
   - 资源压缩

3. **懒加载**
   - 路由懒加载
   - 组件懒加载
   - 图片懒加载

### 后端优化

1. **Railway 自动扩展**
   - 根据负载自动扩展
   - 健康检查
   - 自动重启

2. **缓存策略**
   - 仓库列表缓存
   - 文件内容缓存
   - 提交历史缓存

3. **连接池**
   - Git 进程复用
   - 数据库连接池

## 安全措施

### 前端安全

- ✅ HTTPS 强制
- ✅ XSS 防护（Vue 自动转义）
- ✅ CSRF Token
- ✅ Content Security Policy
- ✅ Cloudflare DDoS 防护

### 后端安全

- ✅ JWT 认证
- ✅ 密码加密（bcrypt）
- ✅ CORS 配置
- ✅ 请求频率限制
- ✅ 输入验证
- ✅ SQL 注入防护（无 SQL）
- ✅ 路径遍历防护

## 监控和日志

### Cloudflare Pages

- 访问统计
- 构建日志
- 错误日志
- 性能指标

### Railway/Render

- 应用日志
- 资源使用（CPU/内存）
- 请求统计
- 错误追踪

### 应用日志

- Git 操作日志（`backend/logs/git-operations.log`）
- 用户操作日志（`backend/logs/operations.log`）
- 系统日志（控制台输出）

## 扩展性

### 水平扩展

```
                    ┌──────────────┐
                    │ Load Balancer│
                    └───────┬──────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
            ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │  Backend 1   │ │  Backend 2   │ │  Backend 3   │
    └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
           │                │                │
           └────────────────┼────────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │ Shared Storage│
                    │  (NFS/S3)    │
                    └──────────────┘
```

### 垂直扩展

- Railway: 升级实例规格
- Render: 升级服务计划
- VPS: 增加 CPU/内存

## 成本分析

### 小型项目（< 10 用户）

| 服务 | 方案 | 成本 |
|------|------|------|
| 前端 | Cloudflare Pages | $0 |
| 后端 | Railway 免费层 | $0 |
| 域名 | 可选 | $10/年 |
| **总计** | | **$0-10/年** |

### 中型项目（10-100 用户）

| 服务 | 方案 | 成本 |
|------|------|------|
| 前端 | Cloudflare Pages | $0 |
| 后端 | Railway Hobby | $5/月 |
| 域名 | 必需 | $10/年 |
| **总计** | | **$70/年** |

### 大型项目（100+ 用户）

| 服务 | 方案 | 成本 |
|------|------|------|
| 前端 | Cloudflare Pages | $0 |
| 后端 | Railway Pro | $20/月 |
| 存储 | 外部存储 | $10/月 |
| 域名 | 必需 | $10/年 |
| **总计** | | **$370/年** |

## 备份策略

### 代码备份

- Git 仓库自动备份到 GitHub
- Railway/Render 自动快照

### 数据备份

```bash
# 备份脚本
#!/bin/bash

# 备份 Git 仓库
tar -czf repos-backup-$(date +%Y%m%d).tar.gz repos/

# 备份配置文件
tar -czf config-backup-$(date +%Y%m%d).tar.gz backend/config/

# 上传到云存储（可选）
# aws s3 cp repos-backup-*.tar.gz s3://your-bucket/
```

### 恢复流程

1. 重新部署应用
2. 恢复配置文件
3. 恢复 Git 仓库
4. 测试功能

## 灾难恢复

### RTO (Recovery Time Objective)

- 前端：< 5 分钟（Cloudflare 自动故障转移）
- 后端：< 15 分钟（重新部署）

### RPO (Recovery Point Objective)

- 代码：0（Git 版本控制）
- 配置：< 1 小时（定期备份）
- 仓库：< 1 小时（定期备份）

---

## 总结

这个架构方案具有以下优势：

✅ **简单易用** - 无需复杂配置  
✅ **成本低廉** - 小项目几乎免费  
✅ **性能优秀** - 全球 CDN 加速  
✅ **安全可靠** - 自动 HTTPS + DDoS 防护  
✅ **易于扩展** - 支持水平和垂直扩展  
✅ **维护简单** - 自动更新和监控  

适合个人项目、小团队和中小型企业使用。
