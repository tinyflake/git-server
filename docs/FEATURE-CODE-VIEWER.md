# 代码查看功能实现文档

## 功能概述

本次更新为 Git 服务器添加了完整的代码查看功能，包括：

1. **文件浏览选项卡** - 在"依赖"选项卡右边
2. **提交历史选项卡** - 在"文件"选项卡右边

## 功能特性

### 1. 文件浏览功能

#### 左侧文件树
- ✅ 树形结构展示仓库文件
- ✅ 懒加载支持（展开时才加载子目录）
- ✅ 文件名搜索功能
- ✅ 显示文件大小
- ✅ 分支切换下拉框

#### 右侧文件预览
- ✅ 代码高亮显示（使用 highlight.js）
- ✅ 支持多种编程语言自动识别
- ✅ 图片预览（使用 Element Plus Image 组件）
- ✅ 大文件处理（>5MB 不预览，只提供下载）
- ✅ 二进制文件提示（不预览，只提供下载）
- ✅ 文件下载按钮
- ✅ 代码复制按钮

### 2. 提交历史功能

#### 提交列表
- ✅ 分支图可视化（圆点+连线）
- ✅ 显示提交哈希值（短哈希）
- ✅ 显示提交信息
- ✅ 显示提交者和时间
- ✅ 显示分支标签和 tag 标签
- ✅ 分支切换下拉框
- ✅ 分页加载（默认 20 条/页）
- ✅ "加载更多"按钮

## 后端 API

### 新增接口

#### 1. 获取文件树
```
GET /api/repo/file-tree
参数:
  - repoPath: 仓库路径
  - branch: 分支名（默认 main）
  - path: 目录路径（可选）
```

#### 2. 获取文件内容
```
GET /api/repo/file-content-with-permission
参数:
  - repoPath: 仓库路径
  - filePath: 文件路径
  - branch: 分支名（默认 main）
返回:
  - content: 文件内容
  - isBinary: 是否二进制文件
  - isImage: 是否图片
  - size: 文件大小
  - tooLarge: 是否过大（>5MB）
  - extension: 文件扩展名
```

#### 3. 获取分支列表
```
GET /api/repo/branches
参数:
  - repoPath: 仓库路径
返回:
  - name: 分支名
  - isCurrent: 是否当前分支
```

#### 4. 获取提交历史
```
GET /api/repo/commits
参数:
  - repoPath: 仓库路径
  - branch: 分支名（默认 main）
  - page: 页码（默认 1）
  - pageSize: 每页数量（默认 20）
返回:
  - commits: 提交列表
    - hash: 完整哈希
    - shortHash: 短哈希
    - author: 作者
    - email: 邮箱
    - date: 日期
    - message: 提交信息
    - branches: 分支列表
    - tags: 标签列表
  - hasMore: 是否有更多
```

## 前端实现

### 组件结构

```
RepoDetail.vue
├── README 选项卡
├── 版本 选项卡
├── 依赖 选项卡
├── 文件 选项卡 (新增)
│   ├── 分支选择器
│   ├── 文件搜索框
│   ├── 文件树面板
│   └── 文件预览面板
│       ├── 文件头部（文件名、大小、操作按钮）
│       └── 文件内容
│           ├── 图片预览
│           ├── 代码高亮
│           ├── 大文件提示
│           └── 二进制文件提示
└── 提交历史 选项卡 (新增)
    ├── 分支选择器
    └── 提交列表
        ├── 提交图（圆点+连线）
        └── 提交信息
            ├── 提交消息
            ├── 分支/标签
            ├── 哈希值
            ├── 作者
            └── 时间
```

### 关键技术

1. **代码高亮**: highlight.js
2. **图片预览**: Element Plus Image 组件
3. **懒加载**: Element Plus Tree 组件的 lazy 模式
4. **文件搜索**: Tree 组件的 filter-node-method

## 使用说明

### 查看文件

1. 进入仓库详情页
2. 点击"文件"选项卡
3. 在左侧文件树中选择分支（可选）
4. 使用搜索框过滤文件（可选）
5. 点击文件名查看内容
6. 使用"复制"或"下载"按钮操作文件

### 查看提交历史

1. 进入仓库详情页
2. 点击"提交历史"选项卡
3. 选择要查看的分支（可选）
4. 浏览提交列表
5. 点击"加载更多"查看更多提交

## 文件类型支持

### 代码文件（高亮显示）
- JavaScript (.js, .jsx)
- TypeScript (.ts, .tsx)
- Vue (.vue)
- HTML (.html)
- CSS (.css, .scss, .less)
- JSON (.json)
- Markdown (.md)
- Python (.py)
- Java (.java)
- C/C++ (.c, .cpp)
- Go (.go)
- Rust (.rs)
- PHP (.php)
- Ruby (.rb)
- Shell (.sh)
- YAML (.yaml, .yml)
- XML (.xml)
- SQL (.sql)

### 图片文件（预览）
- JPG/JPEG
- PNG
- GIF
- BMP
- SVG
- WebP

### 其他文件
- 二进制文件：显示提示，提供下载
- 大文件（>5MB）：显示提示，提供下载

## 性能优化

1. **懒加载**: 文件树按需加载，避免一次性加载大量文件
2. **大文件处理**: 超过 5MB 的文件不预览，减少内存占用
3. **分页加载**: 提交历史分页加载，默认 20 条/页
4. **代码高亮缓存**: 高亮后的代码缓存在组件状态中

## 样式设计

- 采用 GitHub 风格的代码高亮主题
- 清晰的文件树结构
- 直观的提交历史图
- 响应式布局，支持移动端

## 后续扩展建议

1. **权限控制**: 添加代码查看权限管理（已预留接口）
2. **代码搜索**: 在文件内容中搜索关键字
3. **代码对比**: 对比不同版本的文件差异
4. **代码注释**: 支持在线添加代码注释
5. **文件编辑**: 支持在线编辑文件（需要权限）
6. **提交详情**: 点击提交查看详细的文件变更

## 测试建议

1. 测试不同类型的文件预览
2. 测试大文件处理
3. 测试图片预览
4. 测试分支切换
5. 测试文件搜索
6. 测试提交历史加载
7. 测试分页功能

## 已知问题

- TypeScript 类型检查警告（不影响功能）
- 需要确保 Git 命令在服务器上可用

## 部署说明

1. 前端已包含 highlight.js 依赖，无需额外安装
2. 后端使用 child_process 执行 Git 命令，确保服务器已安装 Git
3. 重启前后端服务即可使用新功能
