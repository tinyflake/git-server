# 数据迁移功能使用指南

## 功能概述

数据迁移功能允许超级管理员导出和导入系统的所有数据，包括：
- ✅ 所有用户账户和配置
- ✅ 所有仓库配置和权限
- ✅ 所有仓库代码和提交历史
- ✅ 元数据信息（版本、导出时间等）

## 访问权限

- **仅超级管理员可见**
- 在用户菜单中选择"数据迁移"进入

## 使用场景

### 1. 版本升级
当系统有新版本时，可以：
1. 在旧版本中导出数据
2. 安装新版本
3. 在新版本中导入数据
4. 使用旧版本的账户密码登录

### 2. 数据备份
定期导出数据作为备份，防止数据丢失

### 3. 系统迁移
将数据从一台服务器迁移到另一台服务器

## 导出数据

### 操作步骤

1. 登录系统（使用超级管理员账户）
2. 点击用户菜单 → "数据迁移"
3. 查看当前数据统计
4. 点击"导出所有数据"按钮
5. 等待导出完成（会显示进度）
6. 浏览器自动下载 ZIP 文件

### 导出文件说明

**文件名格式**：`data-backup-2026-01-16T10-30-00.zip`

**文件内容**：
```
data-backup-xxx.zip
├── manifest.json          # 元数据
│   {
│     "version": "2.0.0",
│     "dataVersion": "1",
│     "exportTime": "2026-01-16T10:30:00Z",
│     "userCount": 10,
│     "repoCount": 5,
│     "exportedBy": "admin"
│   }
├── config/
│   ├── users.json         # 用户配置
│   └── repo-config.json   # 仓库配置
└── repos/
    ├── test/              # 仓库1
    ├── project1/          # 仓库2
    └── ...
```

### 注意事项

- 导出时间取决于数据大小，大型仓库可能需要几分钟
- 导出过程中可以继续使用系统
- 建议定期备份数据

## 导入数据

### 操作步骤

1. 登录新系统（使用超级管理员账户）
2. 点击用户菜单 → "数据迁移"
3. 阅读警告信息
4. 拖拽或点击上传备份的 ZIP 文件
5. 点击"开始导入"按钮
6. 确认导入操作
7. 等待导入完成（会显示进度）
8. 导入完成后自动跳转到登录页
9. 使用备份中的账户密码登录

### 导入进度说明

导入过程分为以下阶段：

1. **准备导入** (0-10%)
   - 接收上传的文件

2. **解压文件** (10-30%)
   - 解压 ZIP 文件
   - 验证文件完整性

3. **备份当前数据** (30-40%)
   - 自动备份当前数据（以防导入失败）

4. **恢复配置文件** (40-70%)
   - 恢复用户配置
   - 恢复仓库配置

5. **恢复仓库数据** (70-90%)
   - 恢复所有仓库代码

6. **验证数据** (90-100%)
   - 验证数据完整性
   - 完成导入

### 重要警告

⚠️ **导入数据会覆盖所有现有数据，包括：**

- 🔄 所有用户账户（包括 admin 账户）
- 🔄 所有仓库配置和权限
- 🔄 所有仓库代码
- ⚠️ 此操作不可撤销

**建议**：
- 导入前先导出当前数据作为备份
- 确认备份文件是正确的
- 在测试环境先验证

### Admin 账户说明

导入数据后，admin 账户的密码会被覆盖为备份文件中的密码。

**示例**：
- 旧系统 admin 密码：`oldpassword123`
- 新系统 admin 密码：`123456`（默认）
- 导入后 admin 密码：`oldpassword123`（使用旧系统的密码）

## 故障处理

### 导出失败

**可能原因**：
- 磁盘空间不足
- 仓库文件损坏
- 权限不足

**解决方案**：
1. 检查磁盘空间
2. 检查后端日志
3. 尝试重新导出

### 导入失败

**可能原因**：
- 备份文件损坏
- 文件格式不正确
- 磁盘空间不足
- 版本不兼容

**解决方案**：
1. 验证备份文件是否完整
2. 检查 manifest.json 中的版本信息
3. 检查磁盘空间
4. 查看后端日志获取详细错误信息

**自动回滚**：
如果导入失败，系统会自动回滚到导入前的状态。

### 导入后无法登录

**原因**：
导入后需要使用备份文件中的账户密码，而不是新系统的密码。

**解决方案**：
使用旧系统的账户密码登录。

## 技术细节

### 后端 API

```javascript
// 导出数据
POST /api/migration/export
Response: ZIP 文件流

// 获取导出进度
GET /api/migration/export-progress/:taskId
Response: { progress: 65, message: "正在压缩...", status: "running" }

// 导入数据
POST /api/migration/import
Request: FormData (file)
Response: { taskId: "1234567890" }

// 获取导入进度
GET /api/migration/import-progress/:taskId
Response: { progress: 65, message: "正在恢复仓库...", status: "running" }

// 获取数据统计
GET /api/migration/stats
Response: { userCount: 10, repoCount: 5, totalSize: 1024000 }
```

### 进度轮询

前端每秒轮询一次进度，直到完成或失败。

### 数据备份

导入时会自动备份当前数据到 `backend/backup/` 目录，保留 24 小时。

### 临时文件

- 导出：无临时文件，直接流式传输
- 导入：临时文件存储在 `backend/temp/` 目录，5 分钟后自动清理

## 最佳实践

### 1. 定期备份

建议每周或每月导出一次数据作为备份。

### 2. 版本升级流程

```
1. 在旧版本导出数据
2. 记录导出文件名和时间
3. 安装新版本
4. 在新版本导入数据
5. 验证数据完整性
6. 测试主要功能
```

### 3. 多环境部署

```
开发环境 → 导出数据 → 测试环境 → 导入数据 → 验证
测试环境 → 导出数据 → 生产环境 → 导入数据 → 验证
```

### 4. 灾难恢复

```
1. 保留最近 3 个备份文件
2. 存储在不同位置（本地 + 云端）
3. 定期测试恢复流程
```

## 安全建议

1. **备份文件包含敏感信息**
   - 用户密码（已加密）
   - 仓库代码
   - 配置信息

2. **存储建议**
   - 加密存储备份文件
   - 限制访问权限
   - 定期清理旧备份

3. **传输建议**
   - 使用 HTTPS
   - 不要通过邮件发送
   - 使用安全的文件传输方式

## 常见问题

### Q: 导出的文件有多大？

A: 取决于仓库数量和大小。系统会显示预估大小，压缩后约为原始大小的 60%。

### Q: 导入需要多长时间？

A: 取决于数据大小，通常几秒到几分钟不等。

### Q: 可以选择性导入吗？

A: 当前版本不支持，会导入所有数据。未来版本会支持选择性导入。

### Q: 导入后原来的数据去哪了？

A: 被覆盖了，但系统会自动备份到 `backend/backup/` 目录，保留 24 小时。

### Q: 支持跨版本导入吗？

A: 支持，但建议版本差异不要太大。系统会检查版本兼容性。

### Q: 导入失败会怎样？

A: 系统会自动回滚到导入前的状态，不会丢失数据。

## 更新日志

### v2.0.0 (2026-01-16)
- ✨ 新增数据迁移功能
- ✨ 支持导出/导入所有数据
- ✨ 实时进度显示
- ✨ 自动备份和回滚
- ✨ 数据完整性验证

---

**开发者**：tinyflake  
**最后更新**：2026-01-16  
**版本**：2.0.0
