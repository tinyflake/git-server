# 代码查看权限功能文档

## 功能概述

为代码查看功能添加了完整的权限控制系统，支持细粒度的权限管理。

## 权限层级

### 1. 仓库访问权限（原有功能）
控制用户是否能看到和访问仓库

### 2. 代码查看权限（新增功能）
控制用户是否能查看仓库的代码文件和提交历史

## 权限规则

### 默认规则

| 角色 | 仓库访问 | 代码查看 |
|------|---------|---------|
| 超级管理员 | ✅ 所有仓库 | ✅ 所有仓库 |
| 管理员 | ✅ 根据白名单 | ✅ 默认有权限 |
| 普通用户 | ✅ 根据白名单 | ❌ 默认无权限 |

### 自定义规则

管理员可以为每个仓库单独配置代码查看权限：

1. **默认规则** - 使用上述默认规则
2. **继承访问权限** - 所有能访问仓库的用户都能查看代码
3. **自定义** - 精确指定哪些用户可以查看代码

## 后端实现

### 数据结构

在 `backend/config/repo-config.json` 中，每个仓库新增 `codeViewPermission` 字段：

```json
{
  "repoList": [
    {
      "repoName": "test",
      "repoPath": "C:/path/to/repo",
      "desc": "测试仓库",
      "whitelist": ["user1", "user2"],
      "codeViewPermission": {
        "enabled": true,
        "allowedUsers": ["user1"]
      }
    }
  ]
}
```

### 权限字段说明

- `enabled`: 是否启用自定义权限
  - `false`: 使用默认规则
  - `true`: 使用自定义规则

- `allowedUsers`: 允许查看代码的用户列表
  - 空数组 `[]`: 继承仓库访问权限
  - 非空数组: 只有列表中的用户可以查看

### 新增 API

#### 1. 获取代码查看权限
```
GET /api/repos/:repoName/code-view-permission
```

响应：
```json
{
  "code": 200,
  "data": {
    "repoName": "test",
    "enabled": true,
    "allowedUsers": ["user1"],
    "useDefault": false
  }
}
```

#### 2. 设置代码查看权限
```
PUT /api/repos/:repoName/code-view-permission
```

请求体：
```json
{
  "enabled": true,
  "allowedUsers": ["user1", "user2"]
}
```

响应：
```json
{
  "code": 200,
  "msg": "代码查看权限设置成功",
  "data": {
    "repoName": "test",
    "oldPermission": {...},
    "newPermission": {...}
  }
}
```

### 权限检查函数

在 `backend/utils/repo-permission.js` 中新增：

```javascript
/**
 * 检查用户是否有代码查看权限
 * @param {string} username - 用户名
 * @param {string} userRole - 用户角色
 * @param {string} repoName - 仓库名
 * @returns {boolean} - 是否有权限
 */
function canViewCode(username, userRole, repoName)
```

### 权限验证

在文件内容 API 中添加权限检查：

```javascript
router.get("/file-content-with-permission", authenticateJWT, async (req, res) => {
  // ... 获取参数 ...
  
  // 检查代码查看权限
  const { canViewCode } = require("../utils/repo-permission")
  const hasPermission = canViewCode(
    req.user.username,
    req.user.role,
    repo.repoName
  )

  if (!hasPermission) {
    return res.status(403).json({
      code: 403,
      msg: "您没有查看此仓库代码的权限",
    })
  }
  
  // ... 返回文件内容 ...
})
```

## 前端实现

### 权限管理界面

在 `frontend/src/views/PermissionManagement.vue` 中：

#### 表格列

| 仓库名称 | 描述 | 访问权限 | 代码查看权限 | 操作 |
|---------|------|---------|-------------|------|
| test | 测试 | 公开 | 默认规则 | [访问权限] [代码权限] |

#### 代码权限对话框

```
┌─────────────────────────────────────────┐
│ 设置代码查看权限 - test                   │
├─────────────────────────────────────────┤
│ ℹ️ 代码查看权限说明                       │
│ • 默认规则：超管和管理员有权限            │
│ • 继承访问权限：所有能访问的用户都能查看   │
│ • 自定义：精确控制哪些用户可以查看        │
│                                         │
│ 权限模式：                               │
│ ○ 默认规则                              │
│ ○ 继承访问权限                          │
│ ● 自定义                                │
│                                         │
│ 允许查看的用户：                         │
│ [user1 (普通用户)] [user2 (管理员)]      │
│                                         │
│              [取消]  [保存]              │
└─────────────────────────────────────────┘
```

### API 调用

在 `frontend/src/api/repoManagement.js` 中新增：

```javascript
// 获取仓库代码查看权限
getCodeViewPermission: (repoName) => {
  return repoMgmtApi.get(`/${repoName}/code-view-permission`)
},

// 设置仓库代码查看权限
setCodeViewPermission: (repoName, enabled, allowedUsers) => {
  return repoMgmtApi.put(`/${repoName}/code-view-permission`, {
    enabled,
    allowedUsers,
  })
},
```

## 使用场景

### 场景 1：公开仓库，限制代码查看

**需求**：所有人都能看到仓库存在，但只有特定用户能查看代码

**配置**：
- 访问权限：公开（whitelist 为空）
- 代码权限：自定义（指定用户列表）

### 场景 2：私有仓库，团队成员都能查看代码

**需求**：只有团队成员能访问，且都能查看代码

**配置**：
- 访问权限：私有（whitelist 包含团队成员）
- 代码权限：继承访问权限

### 场景 3：使用默认规则

**需求**：管理员能查看代码，普通用户不能

**配置**：
- 访问权限：根据需要设置
- 代码权限：默认规则

## 权限判断流程

```
用户请求查看代码
    ↓
是超级管理员？
    ├─ 是 → ✅ 允许
    └─ 否 → 继续
         ↓
    仓库存在？
         ├─ 否 → ❌ 拒绝
         └─ 是 → 继续
              ↓
    启用自定义权限？
         ├─ 否 → 使用默认规则
         │        ├─ 管理员 → ✅ 允许
         │        └─ 普通用户 → ❌ 拒绝
         └─ 是 → 继续
                  ↓
            允许列表为空？
                  ├─ 是 → 检查仓库访问权限
                  │        ├─ 有访问权限 → ✅ 允许
                  │        └─ 无访问权限 → ❌ 拒绝
                  └─ 否 → 检查是否在允许列表中
                           ├─ 在列表中 → ✅ 允许
                           └─ 不在列表中 → ❌ 拒绝
```

## 操作指南

### 管理员操作

1. 登录系统
2. 进入"权限管理"页面
3. 找到要配置的仓库
4. 点击"代码权限"按钮
5. 选择权限模式：
   - **默认规则**：管理员有权限，普通用户无权限
   - **继承访问权限**：所有能访问仓库的用户都能查看代码
   - **自定义**：选择特定用户
6. 点击"保存"

### 用户体验

#### 有权限的用户
- 可以看到"文件"和"提交历史"选项卡
- 可以正常浏览代码和查看提交

#### 无权限的用户
- 可以看到"文件"和"提交历史"选项卡
- 点击文件时显示：`您没有查看此仓库代码的权限`
- 提示联系管理员申请权限

## 安全考虑

1. **JWT 认证**：所有 API 都需要 JWT token
2. **角色验证**：只有管理员和超管能设置权限
3. **权限检查**：每次请求都检查权限
4. **操作日志**：记录所有权限变更操作
5. **超管保护**：超管权限不可撤销

## 测试建议

### 功能测试

1. ✅ 超管查看所有仓库代码
2. ✅ 管理员查看有权限的仓库代码
3. ✅ 普通用户查看有权限的仓库代码
4. ✅ 普通用户无法查看无权限的仓库代码
5. ✅ 权限设置立即生效
6. ✅ 权限继承正确
7. ✅ 自定义权限正确

### 边界测试

1. 用户不存在
2. 仓库不存在
3. 权限配置为空
4. 权限配置错误
5. 并发权限修改

## 故障排除

### 问题：用户无法查看代码

**检查步骤**：
1. 确认用户角色
2. 检查仓库访问权限
3. 检查代码查看权限配置
4. 查看后端日志

### 问题：权限设置不生效

**解决方案**：
1. 刷新页面
2. 重新登录
3. 检查后端配置文件
4. 重启后端服务

## 未来扩展

1. **文件级权限**：控制特定文件的查看权限
2. **时间限制**：设置权限的有效期
3. **审批流程**：用户申请权限，管理员审批
4. **权限模板**：预设常用的权限配置
5. **权限报告**：查看权限使用情况

## 总结

✅ 完整的权限控制系统
✅ 灵活的权限配置
✅ 友好的用户界面
✅ 安全的权限验证
✅ 详细的操作日志

代码查看权限功能已完全实现，可以立即使用！
