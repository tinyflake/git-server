# ⚙️ 配置说明

## 配置文件

项目只有**一个配置文件**：`config.json`（根目录）

```json
{
  "server": {
    "host": "localhost",
    "port": 9001,
    "timeout": 300000,
    "maxUploadSize": "1024mb",
    "maxGitUploadSize": "2048mb"
  },
  "frontend": {
    "host": "localhost",
    "port": 5173
  },
  "git": {
    "defaultRepoPath": "./repos"
  },
  "deployment": {
    "mode": "development"
  }
}
```

---

## 配置项说明

### server（后端配置）

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `host` | 后端服务器地址 | `localhost` | `192.168.1.100` 或 `git.yourdomain.com` |
| `port` | 后端服务器端口 | `9001` | `9001` 或 `80` 或 `443` |
| `timeout` | 请求超时时间（毫秒）| `300000` | `300000`（5分钟）|
| `maxUploadSize` | 最大上传大小 | `1024mb` | `1024mb` |
| `maxGitUploadSize` | Git 最大上传大小 | `2048mb` | `2048mb` |

### frontend（前端配置）

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `host` | 前端开发服务器地址 | `localhost` | `localhost` 或 `0.0.0.0` |
| `port` | 前端开发服务器端口 | `5173` | `5173` 或 `3000` |

**注意**：`frontend` 配置只在开发环境（`npm run dev`）时使用。

### git（Git 配置）

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `defaultRepoPath` | Git 仓库存储路径 | `./repos` | `./repos` 或 `/data/repos` |

### deployment（部署配置）

| 配置项 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `mode` | 部署模式 | `development` | `development` 或 `production` |

---

## 配置加载流程

### 开发环境（npm run dev）

```
1. Vite 读取 config.json
   ↓
2. 配置开发服务器（host, port）
   ↓
3. 配置代理（proxy）
   ↓
4. 前端启动时加载 /config.json
   ↓
5. 获取后端地址（server.host, server.port）
```

### 生产环境（npm run build）

```
1. Vite 读取 config.json
   ↓
2. 构建前端
   ↓
3. 复制 config.json 到 dist/
   ↓
4. 前端运行时加载 /config.json
   ↓
5. 获取后端地址
```

---

## 配置优先级

前端获取后端地址的优先级（从高到低）：

1. **localStorage**（用户通过界面修改的配置）
2. **config.json**（运行时加载）
3. **当前域名**（降级方案）

---

## 常见配置场景

### 场景 1：本地开发

```json
{
  "server": {
    "host": "localhost",
    "port": 9001
  },
  "frontend": {
    "host": "localhost",
    "port": 5173
  }
}
```

访问：
- 前端：http://localhost:5173
- 后端：http://localhost:9001

### 场景 2：局域网开发（手机测试）

```json
{
  "server": {
    "host": "192.168.1.100",
    "port": 9001
  },
  "frontend": {
    "host": "0.0.0.0",
    "port": 5173
  }
}
```

访问：
- 前端：http://192.168.1.100:5173
- 后端：http://192.168.1.100:9001

### 场景 3：生产部署（同一服务器）

```json
{
  "server": {
    "host": "192.168.1.100",
    "port": 9001
  },
  "deployment": {
    "mode": "production"
  }
}
```

访问：
- 前端：http://192.168.1.100:9001（后端托管前端）
- 后端：http://192.168.1.100:9001

### 场景 4：生产部署（域名 + HTTPS）

```json
{
  "server": {
    "host": "git.yourdomain.com",
    "port": 443
  },
  "deployment": {
    "mode": "production"
  }
}
```

访问：
- 前端：https://git.yourdomain.com
- 后端：https://git.yourdomain.com

---

## 修改配置

### 开发环境

1. 修改根目录 `config.json`
2. 重启开发服务器
   ```bash
   # 后端
   cd backend
   npm start
   
   # 前端
   cd frontend
   npm run dev
   ```

### 生产环境

#### 方法 1：重新构建（推荐）

1. 修改根目录 `config.json`
2. 重新构建
   ```bash
   build-release.bat
   ```
3. 部署 `release` 目录

#### 方法 2：直接修改部署文件

1. 修改服务器上的 `release/backend/dist/config.json`
2. 刷新浏览器（清除缓存）

**注意**：方法 2 下次构建会被覆盖。

---

## 用户自定义配置

用户可以通过界面修改配置：

1. 登录系统
2. 点击右上角"配置"按钮
3. 修改服务器地址和端口
4. 保存

配置会保存到 `localStorage`，优先级最高。

---

## 配置验证

### 检查配置文件

```bash
# 开发环境
type config.json

# 生产环境
type release\backend\dist\config.json
```

### 浏览器验证

1. 打开浏览器控制台（F12）
2. 查看启动日志：
   ```
   🚀 正在初始化应用...
   📡 正在从服务器加载 config.json...
   ✅ 成功加载 config.json: {server: {...}}
   ✅ 配置加载完成
   ✅ 应用启动完成
   ```

3. 查看网络请求：
   - Network 标签
   - 查看 API 请求的 URL

---

## 故障排除

### 问题 1：前端无法加载 config.json

**症状**：控制台显示 `⚠️  加载 config.json 失败`

**原因**：
- config.json 不存在
- config.json 格式错误
- 网络问题

**解决**：
1. 检查 `frontend/dist/config.json` 是否存在
2. 验证 JSON 格式：https://jsonlint.com/
3. 查看浏览器 Network 标签

### 问题 2：前端请求错误的地址

**症状**：API 请求指向 localhost

**原因**：
- config.json 中的 host 配置错误
- 浏览器缓存

**解决**：
1. 检查 config.json 中的 `server.host`
2. 清除浏览器缓存
3. 使用隐私模式测试

### 问题 3：开发环境代理失败

**症状**：开发环境 API 请求 404

**原因**：
- 后端未启动
- 代理配置错误

**解决**：
1. 确认后端已启动：http://localhost:9001/api
2. 检查 `vite.config.js` 中的 proxy 配置
3. 重启前端开发服务器

---

## 最佳实践

### 1. 版本控制

```bash
# 提交 config.json 模板
git add config.json

# 忽略本地修改
git update-index --assume-unchanged config.json
```

### 2. 多环境配置

创建不同的配置文件：

```
config.json              # 默认配置
config.development.json  # 开发环境
config.production.json   # 生产环境
```

部署时复制对应的配置：

```bash
copy config.production.json config.json
build-release.bat
```

### 3. 敏感信息

不要在 config.json 中存储敏感信息（如密码、密钥）。

使用环境变量或独立的配置文件。

---

## 总结

✅ **统一配置**：只有一个 `config.json`  
✅ **运行时加载**：前端动态获取配置  
✅ **自动复制**：构建时自动处理  
✅ **灵活部署**：支持任意服务器地址  
✅ **用户自定义**：支持界面修改配置  

**简单、灵活、易维护！** 🎉
